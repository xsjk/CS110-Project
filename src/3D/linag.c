#include "3D/linag.h"
#include <math.h>



Vec3 vec3_add(Vec3 a, Vec3 b) {
    return (Vec3) {{a.x + b.x, a.y + b.y, a.z + b.z}};
}

Vec3 vec3_sub(Vec3 a, Vec3 b) {
    return (Vec3) {{a.x - b.x, a.y - b.y, a.z - b.z}};
}

Vec3 vec3_scale(Vec3 a, float b) {
    return (Vec3) {{a.x * b, a.y * b, a.z * b }};
}

Vec3 cross(Vec3 a, Vec3 b) {
    return (Vec3) {{a.y * b.z - a.z * b.y, a.z * b.x - a.x * b.z, a.x * b.y - a.y * b.x }};
}

float dot(Vec3 a, Vec3 b) {
    return a.x * b.x + a.y * b.y + a.z * b.z;
}

float vec3_length(Vec3 a) {
    return sqrtf(a.x * a.x + a.y * a.y + a.z * a.z);
}

Vec3 normalize(Vec3 a) {
    return vec3_scale(a, 1.f / vec3_length(a));
}


Mat3 mat3_identity() {
    return (Mat3) {{ 1, 0, 0,
                     0, 1, 0,
                     0, 0, 1 }};
}


Mat3 mat3_transpose(Mat3 m) {
    return (Mat3) {{
        m.m[0][0],
        m.m[1][0],
        m.m[2][0],
        m.m[0][1],
        m.m[1][1],
        m.m[2][1],
        m.m[0][2],
        m.m[1][2],
        m.m[2][2]
    }};
}

Mat3 mat3_scale(Mat3 m, float s) {
    return (Mat3) {{
        m.m[0][0] * s,
        m.m[0][1] * s,
        m.m[0][2] * s,
        m.m[1][0] * s,
        m.m[1][1] * s,
        m.m[1][2] * s,
        m.m[2][0] * s,
        m.m[2][1] * s,
        m.m[2][2] * s
    }};
}

float mat3_det(Mat3 m) {
    return m.m[0][0] * (m.m[1][1] * m.m[2][2] - m.m[1][2] * m.m[2][1]) -
        m.m[0][1] * (m.m[1][0] * m.m[2][2] - m.m[1][2] * m.m[2][0]) +
        m.m[0][2] * (m.m[1][0] * m.m[2][1] - m.m[1][1] * m.m[2][0]);
}

Mat3 mat3_inverse(Mat3 m) {
    float det = mat3_det(m);
    float invdet = 1 / det;
    return (Mat3) {{
        (m.m[1][1] * m.m[2][2] - m.m[1][2] * m.m[2][1]) * invdet,
        (m.m[0][2] * m.m[2][1] - m.m[0][1] * m.m[2][2]) * invdet,
        (m.m[0][1] * m.m[1][2] - m.m[0][2] * m.m[1][1]) * invdet,
        (m.m[1][2] * m.m[2][0] - m.m[1][0] * m.m[2][2]) * invdet,
        (m.m[0][0] * m.m[2][2] - m.m[0][2] * m.m[2][0]) * invdet,
        (m.m[1][0] * m.m[0][2] - m.m[0][0] * m.m[1][2]) * invdet,
        (m.m[1][0] * m.m[2][1] - m.m[2][0] * m.m[1][1]) * invdet,
        (m.m[2][0] * m.m[0][1] - m.m[0][0] * m.m[2][1]) * invdet,
        (m.m[0][0] * m.m[1][1] - m.m[1][0] * m.m[0][1]) * invdet
    }};
}

Mat3 mat3_mul(Mat3 a, Mat3 b) {
    return (Mat3) {{
        a.m[0][0] * b.m[0][0] + a.m[0][1] * b.m[1][0] + a.m[0][2] * b.m[2][0],
        a.m[0][0] * b.m[0][1] + a.m[0][1] * b.m[1][1] + a.m[0][2] * b.m[2][1],
        a.m[0][0] * b.m[0][2] + a.m[0][1] * b.m[1][2] + a.m[0][2] * b.m[2][2],
        a.m[1][0] * b.m[0][0] + a.m[1][1] * b.m[1][0] + a.m[1][2] * b.m[2][0],
        a.m[1][0] * b.m[0][1] + a.m[1][1] * b.m[1][1] + a.m[1][2] * b.m[2][1],
        a.m[1][0] * b.m[0][2] + a.m[1][1] * b.m[1][2] + a.m[1][2] * b.m[2][2],
        a.m[2][0] * b.m[0][0] + a.m[2][1] * b.m[1][0] + a.m[2][2] * b.m[2][0],
        a.m[2][0] * b.m[0][1] + a.m[2][1] * b.m[1][1] + a.m[2][2] * b.m[2][1],
        a.m[2][0] * b.m[0][2] + a.m[2][1] * b.m[1][2] + a.m[2][2] * b.m[2][2]
    }};
}



Vec3 mat3_transform(Vec3 a, Mat3 m) {
    return (Vec3) {{
        a.x * m.m[0][0] + a.y * m.m[1][0] + a.z * m.m[2][0],
        a.x * m.m[0][1] + a.y * m.m[1][1] + a.z * m.m[2][1],
        a.x * m.m[0][2] + a.y * m.m[1][2] + a.z * m.m[2][2]
    }};
}


Vec4 vec4_add(Vec4 a, Vec4 b) {
    return (Vec4) {{a.x + b.x, a.y + b.y, a.z + b.z, 1.0f}};
}

Vec4 vec4_sub(Vec4 a, Vec4 b) {
    return (Vec4) {{a.x - b.x, a.y - b.y, a.z - b.z, 1.0f}};
}

Vec4 vec4_scale(Vec4 a, float b) {
    return (Vec4) {{a.x * b, a.y * b, a.z * b, 1.0f}};
}

Vec4 vec4_transform(Vec4 a, Mat4 m) {
    return (Vec4) {{
        a.x * m.m[0][0] + a.y * m.m[1][0] + a.z * m.m[2][0] + a.w * m.m[3][0],
        a.x * m.m[0][1] + a.y * m.m[1][1] + a.z * m.m[2][1] + a.w * m.m[3][1],
        a.x * m.m[0][2] + a.y * m.m[1][2] + a.z * m.m[2][2] + a.w * m.m[3][2],
        a.x * m.m[0][3] + a.y * m.m[1][3] + a.z * m.m[2][3] + a.w * m.m[3][3]
    }};
}

Vec4 vec4_transfrom(Vec4 a, Mat4 m) {
    return (Vec4) {{
        a.x * m.m[0][0] + a.y * m.m[1][0] + a.z * m.m[2][0] + a.w * m.m[3][0],
        a.x * m.m[0][1] + a.y * m.m[1][1] + a.z * m.m[2][1] + a.w * m.m[3][1],
        a.x * m.m[0][2] + a.y * m.m[1][2] + a.z * m.m[2][2] + a.w * m.m[3][2],
        a.x * m.m[0][3] + a.y * m.m[1][3] + a.z * m.m[2][3] + a.w * m.m[3][3]
    }};
}

Vec3 mat4_transform(Vec3 a, Mat4 m) {
    return (Vec3) {{
        a.x * m.m[0][0] + a.y * m.m[1][0] + a.z * m.m[2][0] + m.m[3][0],
        a.x * m.m[0][1] + a.y * m.m[1][1] + a.z * m.m[2][1] + m.m[3][1],
        a.x * m.m[0][2] + a.y * m.m[1][2] + a.z * m.m[2][2] + m.m[3][2]
    }};
}


Mat4 mat4_identity() {
    return (Mat4) {{ 1, 0, 0, 0,
                     0, 1, 0, 0,
                     0, 0, 1, 0,
                     0, 0, 0, 1 }};
}

Mat4 mat4_scale(Mat4 m, float s) {
    return (Mat4) {{
        m.m[0][0] * s,
        m.m[0][1] * s,
        m.m[0][2] * s,
        m.m[0][3] * s,
        m.m[1][0] * s,
        m.m[1][1] * s,
        m.m[1][2] * s,
        m.m[1][3] * s,
        m.m[2][0] * s,
        m.m[2][1] * s,
        m.m[2][2] * s,
        m.m[2][3] * s,
        m.m[3][0] * s,
        m.m[3][1] * s,
        m.m[3][2] * s,
        m.m[3][3] * s
    }};
}


float mat4_det(Mat4 m) {
    return m.m[3][0] * (
        m.m[0][1] * (m.m[1][2] * m.m[2][3] - m.m[1][3] * m.m[2][2]) +
        m.m[0][2] * (m.m[1][3] * m.m[2][1] - m.m[1][1] * m.m[2][3]) +
        m.m[0][3] * (m.m[1][1] * m.m[2][2] - m.m[1][2] * m.m[2][1])
    ) + m.m[3][1] * (
        m.m[0][0] * (m.m[1][3] * m.m[2][2] - m.m[1][2] * m.m[2][3]) +
        m.m[0][2] * (m.m[1][0] * m.m[2][3] - m.m[1][3] * m.m[2][0]) +
        m.m[0][3] * (m.m[1][2] * m.m[2][0] - m.m[1][0] * m.m[2][2])
    ) + m.m[3][2] * (
        m.m[0][0] * (m.m[1][1] * m.m[2][3] - m.m[1][3] * m.m[2][1]) +
        m.m[0][1] * (m.m[1][3] * m.m[2][0] - m.m[1][0] * m.m[2][3]) +
        m.m[0][3] * (m.m[1][0] * m.m[2][1] - m.m[1][1] * m.m[2][0])
    ) + m.m[3][3] * (
        m.m[0][0] * (m.m[1][2] * m.m[2][1] - m.m[1][1] * m.m[2][2]) +
        m.m[0][1] * (m.m[1][0] * m.m[2][2] - m.m[1][2] * m.m[2][0]) +
        m.m[0][2] * (m.m[1][1] * m.m[2][0] - m.m[1][0] * m.m[2][1])
    );
}

Mat4 mat4_inverse(Mat4 m) {
    float det = mat4_det(m);
    float invdet = 1.0f / det;
    if (det == 0)
        return (Mat4){0};
    else
        return (Mat4){{ 
            (m.m[1][1] * m.m[2][2] * m.m[3][3] - m.m[1][1] * m.m[2][3] * m.m[3][2] - m.m[2][1] * m.m[1][2] * m.m[3][3] + m.m[2][1] * m.m[1][3] * m.m[3][2] + m.m[3][1] * m.m[1][2] * m.m[2][3] - m.m[3][1] * m.m[1][3] * m.m[2][2]) * invdet,
            (-m.m[0][1] * m.m[2][2] * m.m[3][3] + m.m[0][1] * m.m[2][3] * m.m[3][2] + m.m[2][1] * m.m[0][2] * m.m[3][3] - m.m[2][1] * m.m[0][3] * m.m[3][2] - m.m[3][1] * m.m[0][2] * m.m[2][3] + m.m[3][1] * m.m[0][3] * m.m[2][2]) * invdet,
            (m.m[0][1] * m.m[1][2] * m.m[3][3] - m.m[0][1] * m.m[1][3] * m.m[3][2] - m.m[1][1] * m.m[0][2] * m.m[3][3] + m.m[1][1] * m.m[0][3] * m.m[3][2] + m.m[3][1] * m.m[0][2] * m.m[1][3] - m.m[3][1] * m.m[0][3] * m.m[1][2]) * invdet,
            (-m.m[0][1] * m.m[1][2] * m.m[2][3] + m.m[0][1] * m.m[1][3] * m.m[2][2] + m.m[1][1] * m.m[0][2] * m.m[2][3] - m.m[1][1] * m.m[0][3] * m.m[2][2] - m.m[2][1] * m.m[0][2] * m.m[1][3] + m.m[2][1] * m.m[0][3] * m.m[1][2]) * invdet,
            (-m.m[1][0] * m.m[2][2] * m.m[3][3] + m.m[1][0] * m.m[2][3] * m.m[3][2] + m.m[2][0] * m.m[1][2] * m.m[3][3] - m.m[2][0] * m.m[1][3] * m.m[3][2] - m.m[3][0] * m.m[1][2] * m.m[2][3] + m.m[3][0] * m.m[1][3] * m.m[2][2]) * invdet,
            (m.m[0][0] * m.m[2][2] * m.m[3][3] - m.m[0][0] * m.m[2][3] * m.m[3][2] - m.m[2][0] * m.m[0][2] * m.m[3][3] + m.m[2][0] * m.m[0][3] * m.m[3][2] + m.m[3][0] * m.m[0][2] * m.m[2][3] - m.m[3][0] * m.m[0][3] * m.m[2][2]) * invdet,
            (-m.m[0][0] * m.m[1][2] * m.m[3][3] + m.m[0][0] * m.m[1][3] * m.m[3][2] + m.m[1][0] * m.m[0][2] * m.m[3][3] - m.m[1][0] * m.m[0][3] * m.m[3][2] - m.m[3][0] * m.m[0][2] * m.m[1][3] + m.m[3][0] * m.m[0][3] * m.m[1][2]) * invdet,
            (m.m[0][0] * m.m[1][2] * m.m[2][3] - m.m[0][0] * m.m[1][3] * m.m[2][2] - m.m[1][0] * m.m[0][2] * m.m[2][3] + m.m[1][0] * m.m[0][3] * m.m[2][2] + m.m[2][0] * m.m[0][2] * m.m[1][3] - m.m[2][0] * m.m[0][3] * m.m[1][2]) * invdet,
            (m.m[1][0] * m.m[2][1] * m.m[3][3] - m.m[1][0] * m.m[2][3] * m.m[3][1] - m.m[2][0] * m.m[1][1] * m.m[3][3] + m.m[2][0] * m.m[1][3] * m.m[3][1] + m.m[3][0] * m.m[1][1] * m.m[2][3] - m.m[3][0] * m.m[1][3] * m.m[2][1]) * invdet,
            (-m.m[0][0] * m.m[2][1] * m.m[3][3] + m.m[0][0] * m.m[2][3] * m.m[3][1] + m.m[2][0] * m.m[0][1] * m.m[3][3] - m.m[2][0] * m.m[0][3] * m.m[3][1] - m.m[3][0] * m.m[0][1] * m.m[2][3] + m.m[3][0] * m.m[0][3] * m.m[2][1]) * invdet,
            (m.m[0][0] * m.m[1][1] * m.m[3][3] - m.m[0][0] * m.m[1][3] * m.m[3][1] - m.m[1][0] * m.m[0][1] * m.m[3][3] + m.m[1][0] * m.m[0][3] * m.m[3][1] + m.m[3][0] * m.m[0][1] * m.m[1][3] - m.m[3][0] * m.m[0][3] * m.m[1][1]) * invdet,
            (-m.m[0][0] * m.m[1][1] * m.m[2][3] + m.m[0][0] * m.m[1][3] * m.m[2][1] + m.m[1][0] * m.m[0][1] * m.m[2][3] - m.m[1][0] * m.m[0][3] * m.m[2][1] - m.m[2][0] * m.m[0][1] * m.m[1][3] + m.m[2][0] * m.m[0][3] * m.m[1][1]) * invdet,
            (-m.m[1][0] * m.m[2][1] * m.m[3][2] + m.m[1][0] * m.m[2][2] * m.m[3][1] + m.m[2][0] * m.m[1][1] * m.m[3][2] - m.m[2][0] * m.m[1][2] * m.m[3][1] - m.m[3][0] * m.m[1][1] * m.m[2][2] + m.m[3][0] * m.m[1][2] * m.m[2][1]) * invdet,
            (m.m[0][0] * m.m[2][1] * m.m[3][2] - m.m[0][0] * m.m[2][2] * m.m[3][1] - m.m[2][0] * m.m[0][1] * m.m[3][2] + m.m[2][0] * m.m[0][2] * m.m[3][1] + m.m[3][0] * m.m[0][1] * m.m[2][2] - m.m[3][0] * m.m[0][2] * m.m[2][1]) * invdet,
            (-m.m[0][0] * m.m[1][1] * m.m[3][2] + m.m[0][0] * m.m[1][2] * m.m[3][1] + m.m[1][0] * m.m[0][1] * m.m[3][2] - m.m[1][0] * m.m[0][2] * m.m[3][1] - m.m[3][0] * m.m[0][1] * m.m[1][2] + m.m[3][0] * m.m[0][2] * m.m[1][1]) * invdet,
            (m.m[0][0] * m.m[1][1] * m.m[2][2] - m.m[0][0] * m.m[1][2] * m.m[2][1] - m.m[1][0] * m.m[0][1] * m.m[2][2] + m.m[1][0] * m.m[0][2] * m.m[2][1] + m.m[2][0] * m.m[0][1] * m.m[1][2] - m.m[2][0] * m.m[0][2] * m.m[1][1]) * invdet
        }};
}

Mat4 mat4_mul(Mat4 a, Mat4 b) {
    return (Mat4) {{
        a.m[0][0] * b.m[0][0] + a.m[0][1] * b.m[1][0] + a.m[0][2] * b.m[2][0] + a.m[0][3] * b.m[3][0],
        a.m[0][0] * b.m[0][1] + a.m[0][1] * b.m[1][1] + a.m[0][2] * b.m[2][1] + a.m[0][3] * b.m[3][1],
        a.m[0][0] * b.m[0][2] + a.m[0][1] * b.m[1][2] + a.m[0][2] * b.m[2][2] + a.m[0][3] * b.m[3][2],
        a.m[0][0] * b.m[0][3] + a.m[0][1] * b.m[1][3] + a.m[0][2] * b.m[2][3] + a.m[0][3] * b.m[3][3],
        a.m[1][0] * b.m[0][0] + a.m[1][1] * b.m[1][0] + a.m[1][2] * b.m[2][0] + a.m[1][3] * b.m[3][0],
        a.m[1][0] * b.m[0][1] + a.m[1][1] * b.m[1][1] + a.m[1][2] * b.m[2][1] + a.m[1][3] * b.m[3][1],
        a.m[1][0] * b.m[0][2] + a.m[1][1] * b.m[1][2] + a.m[1][2] * b.m[2][2] + a.m[1][3] * b.m[3][2],
        a.m[1][0] * b.m[0][3] + a.m[1][1] * b.m[1][3] + a.m[1][2] * b.m[2][3] + a.m[1][3] * b.m[3][3],
        a.m[2][0] * b.m[0][0] + a.m[2][1] * b.m[1][0] + a.m[2][2] * b.m[2][0] + a.m[2][3] * b.m[3][0],
        a.m[2][0] * b.m[0][1] + a.m[2][1] * b.m[1][1] + a.m[2][2] * b.m[2][1] + a.m[2][3] * b.m[3][1],
        a.m[2][0] * b.m[0][2] + a.m[2][1] * b.m[1][2] + a.m[2][2] * b.m[2][2] + a.m[2][3] * b.m[3][2],
        a.m[2][0] * b.m[0][3] + a.m[2][1] * b.m[1][3] + a.m[2][2] * b.m[2][3] + a.m[2][3] * b.m[3][3],
        a.m[3][0] * b.m[0][0] + a.m[3][1] * b.m[1][0] + a.m[3][2] * b.m[2][0] + a.m[3][3] * b.m[3][0],
        a.m[3][0] * b.m[0][1] + a.m[3][1] * b.m[1][1] + a.m[3][2] * b.m[2][1] + a.m[3][3] * b.m[3][1],
        a.m[3][0] * b.m[0][2] + a.m[3][1] * b.m[1][2] + a.m[3][2] * b.m[2][2] + a.m[3][3] * b.m[3][2],
        a.m[3][0] * b.m[0][3] + a.m[3][1] * b.m[1][3] + a.m[3][2] * b.m[2][3] + a.m[3][3] * b.m[3][3]
    }};
}

Vec3 vec3_from_vec4(Vec4 v) {
    return (Vec3){{v.x / v.w, v.y / v.w, v.z / v.w}};
}

Vec4 vec4_from_vec3(Vec3 v) {
    return (Vec4){{v.x, v.y, v.z, 1}};
}